{
  "variables": {
    "identity_endpoint": "{{env `OS_AUTH_URL`}}",
    "domain_name": "{{env `OS_PROJECT_DOMAIN_NAME`}}",
    "tenant_name": "{{env `OS_PROJECT_NAME`}}",
    "username": "{{env `OS_USERNAME`}}",
    "password": "{{env `OS_PASSWORD`}}",
    "region": "{{env `OS_REGION`}}",
    "source_image_name": "",
    "network_uuid": "",
    "security_group": "",
    "ssh_keypair_name": "",
    "image_build_name": "",
    "vs_download_url": "",
    "nuget_download_url": "",
    "bosh_ps_modules_download_url": "",
    "bosh_agent_download_url": "",
    "openssh_win64_download_url": "",
    "custom_file_upload": "",
    "custom_ps1_script": "",
    "root_dir": ""
  },
  "builders": [
    {
      "type": "openstack",
      "insecure": "true",
      "identity_endpoint": "{{user `identity_endpoint`}}",
      "domain_name": "{{user `domain_name`}}",
      "tenant_name": "{{user `tenant_name`}}",
      "username": "{{user `username`}}",
      "password": "{{user `password`}}",
      "region": "{{user `region`}}",
      "source_image_name": "{{user `source_image_name`}}",
      "volume_size": 40,
      "use_blockstorage_volume": true,
      "flavor": "m1.large",
      "networks": [
        "{{user `network_uuid`}}"
      ],
      "security_groups": [
        "{{user `security_group`}}"
      ],
      "ssh_keypair_name": "{{user `ssh_keypair_name`}}",
      "ssh_private_key_file": "{{user `root_dir`}}/keys/pcf.pem",
      "user_data_file": "{{user `root_dir`}}/src/stemcells/scripts/windows/prepare.ps1",
      "image_name": "{{user `image_build_name`}}",
      "communicator": "winrm",
      "winrm_username": "Administrator",
      "winrm_password": "P@ssw0rd",
      "winrm_timeout": "3600s"
    }
  ],
  "provisioners": [
    {
      "type": "file",
      "source": "{{user `root_dir`}}/src/stemcells/scripts/windows/",
      "destination": "C:\\Stemcell-Build\\Scripts"
    },
    {
      "type": "file",
      "source": "{{user `custom_file_upload`}}",
      "destination": "C:\\Stemcell-Build\\Downloads\\"
    },
    {
      "type": "file",
      "source": "{{user `custom_ps1_script`}}",
      "destination": "C:\\Stemcell-Build\\Scripts\\install-custom.ps1"
    },
    {
      "type": "windows-shell",
      "inline": [
        "PowerShell.exe -ExecutionPolicy Bypass C:\\Stemcell-Build\\Scripts\\download-wmf51.ps1"
      ]
    },
    {
      "type": "windows-shell",
      "inline": [
        "PowerShell.exe -ExecutionPolicy Bypass C:\\Stemcell-Build\\Scripts\\download-vs.ps1 {{user `vs_download_url`}} {{user `nuget_download_url`}}"
      ]
    },
    {
      "type": "windows-shell",
      "inline": [
        "PowerShell.exe -ExecutionPolicy Bypass C:\\Stemcell-Build\\Scripts\\download-bosh.ps1 {{user `bosh_ps_modules_download_url`}} {{user `bosh_agent_download_url`}} {{user `openssh_win64_download_url`}}"
      ]
    },
    {
      "type": "windows-shell",
      "inline": [
        "PowerShell.exe -ExecutionPolicy Bypass C:\\Stemcell-Build\\Scripts\\install-wmf51.ps1"
      ]
    },
    {
      "type": "windows-restart"
    },
    {
      "type": "windows-shell",
      "inline": [
        "PowerShell.exe -ExecutionPolicy Bypass C:\\Stemcell-Build\\Scripts\\install-vs.ps1"
      ]
    },
    {
      "type": "windows-restart"
    },
    {
      "type": "windows-shell",
      "inline": [
        "PowerShell.exe -ExecutionPolicy Bypass C:\\Stemcell-Build\\Scripts\\install-custom.ps1"
      ]
    },
    {
      "type": "windows-restart"
    },
    {
      "type": "windows-shell",
      "inline": [
        "PowerShell.exe -ExecutionPolicy Bypass C:\\Stemcell-Build\\Scripts\\configure-stemcell.ps1"
      ]
    },
    {
      "type": "windows-update"
    }
  ]
}